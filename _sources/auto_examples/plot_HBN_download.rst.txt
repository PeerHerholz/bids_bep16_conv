
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "auto_examples/plot_HBN_download.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        Click :ref:`here <sphx_glr_download_auto_examples_plot_HBN_download.py>`
        to download the full example code

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_auto_examples_plot_HBN_download.py:


Fetching the HBN example dataset
================================
This example demonstrates how to use :mod:`bids_bep16_conv.datasets` to fetch
the HBN example dataset.

.. GENERATED FROM PYTHON SOURCE LINES 10-27

Much of the functionality of the ``bids_bep16_conv`` toolbox relies on downloading
candidate example datasets. Each dataset has its own functions to check and evaluate QC
files to find suitable participants, as well as dedicated download functions that will obtain
the data from the BIDS connectivity OSF project. The respective files differ between example datasets
and respectively utilized pipeline/workflow but are obtained in a way that they confirm
to BIDS common derivatives, specifically as input for tools that generate BEP16-related output.

Here we show how the HBN example dataset was generated and can be assessed, via describing the respective
workflow and utilized ``functions``.

The ``HBN dataset`` and its derivatives are provided openly via the
`FCP-INDI AWS bucket <https://fcp-indi.s3.amazonaws.com/index.html#data/Projects/HBN/>`_, entailing various
pipeline/workflow outputs. Here, we are going to focus on the preprocessing conducted via ``QSIprep``.

At first, we need to find a suitable ``participant``, in terms of overall data quality, Luckily, ``QSIprep``
provides a respective file that includes a ``quality control score`` for each ``participant``.
Using the :func:`datasets.get_HBN_qc` function we can obtain and check this file:

.. GENERATED FROM PYTHON SOURCE LINES 27-33

.. code-block:: default


    from bids_bep16_conv import datasets

    HBN_qc_file = datasets.get_HBN_qc(return_df=True)
    print(HBN_qc_file)





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Data will be downloaded to bids_bep16_datasets/HBN/source-HBN_desc-qsiprep_participants.tsv
      0%|          | 0/210607 [00:00<?, ?it/s]    100%|##########| 206k/206k [00:00<00:00, 31.6MB/s]
                subject_id scan_site_id  ... dl_qc_score            site_variant
    0     sub-NDARAA306NT2           RU  ...       0.470    RU_64dir_Most_Common
    1     sub-NDARAA536PTU           SI  ...       0.701      SI_64dir_Obliquity
    2     sub-NDARAA947ZG5         CBIC  ...       0.509  CBIC_64dir_Most_Common
    3     sub-NDARAA948VFH           RU  ...       0.979    RU_64dir_Most_Common
    4     sub-NDARAB055BPR           RU  ...       0.035    RU_64dir_Most_Common
    ...                ...          ...  ...         ...                     ...
    2129  sub-NDARZW873DN3         CBIC  ...       0.982  CBIC_64dir_Most_Common
    2130  sub-NDARZX163EWC         CBIC  ...       0.993  CBIC_64dir_Most_Common
    2131  sub-NDARZY101JNB         CBIC  ...       0.992  CBIC_64dir_Most_Common
    2132  sub-NDARZZ740MLM           RU  ...       0.014    RU_64dir_Most_Common
    2133  sub-NDARZZ810LVF         CBIC  ...       0.861  CBIC_64dir_Most_Common

    [2134 rows x 12 columns]




.. GENERATED FROM PYTHON SOURCE LINES 34-42

What we get is a :class:`~pandas.DataFrame` entailing the content of ``QSIprep``'s ``participant.tsv`` file.
In contains various ``demographic variables`` but also the ``Quality Control scores`` we are interested in.
In order to make the respective evaluation more straightforward, we can use the :func:`datasets.get_HBN_qc` function,
which will sort the :class:`~pandas.DataFrame` based on the ``dl_qc_score`` variable. We can furthermore indicate how
many ``participants`` with the highest score, as well as if the sorted :class:`~pandas.DataFrame`
and a ``raincloud plot`` of the ``dl_qc_score`` variable across the ``dataset`` should be returned.

Here, we going to get the ``participants`` that have the ``3`` highest scores, the sorted :class:`~pandas.DataFrame` and the ``raincloud plot``.

.. GENERATED FROM PYTHON SOURCE LINES 42-47

.. code-block:: default


    HBN_qc_participants_df_sorted = datasets.eval_HBN_qc(HBN_qc_file,
                                                         n_high_participants=3,
                                                         visualize=True, return_sorted_df=True)




.. image-sg:: /auto_examples/images/sphx_glr_plot_HBN_download_001.png
   :alt: plot HBN download
   :srcset: /auto_examples/images/sphx_glr_plot_HBN_download_001.png
   :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    The 3 participants with the highest QC score are: 
    418     sub-NDAREK918EC2
    2002    sub-NDARYM277DEA
    1151    sub-NDARMV189NXG
    Name: subject_id, dtype: object
    /usr/share/miniconda/envs/bids_bep16_conv/lib/python3.9/site-packages/seaborn/_core.py:1303: UserWarning: Vertical orientation ignored with only `x` specified.
      warnings.warn(single_var_warning.format("Vertical", "x"))
    /usr/share/miniconda/envs/bids_bep16_conv/lib/python3.9/site-packages/seaborn/_core.py:1303: UserWarning: Vertical orientation ignored with only `x` specified.
      warnings.warn(single_var_warning.format("Vertical", "x"))
    /usr/share/miniconda/envs/bids_bep16_conv/lib/python3.9/site-packages/seaborn/_core.py:1303: UserWarning: Vertical orientation ignored with only `x` specified.
      warnings.warn(single_var_warning.format("Vertical", "x"))




.. GENERATED FROM PYTHON SOURCE LINES 48-60

As you can see in the ``raincloud plot``, the score has a rather interesting distribution but the
above obtained :class:`~pandas.Series` indicates that ``participant`` ``sub-NDAREK918EC2`` has the
highest ``dl_qc_score``. However, upon closer inspection it was noticed that this participant doesn't 
have all files necessary to test multiple analysis pipelines and the respective conversion to BEP16.
Thus, the ``participant``'s data with the second highest ``dl_qc_score`` was utilized. This refers to
``sub-NDARYM277DEA``'s `QSIprep outputs <https://fcp-indi.s3.amazonaws.com/index.html#data/Projects/HBN/BIDS_curated/derivatives/qsiprep/sub-NDARYM277DEA/>`_
which were downloaded from the `FCP-INDI AWS bucket <https://fcp-indi.s3.amazonaws.com/index.html#data/Projects/HBN/>`_ and subsequently
uploaded to the `dataset component <https://osf.io/bz2vj/>`_ of the `BIDS connectivity project <https://pestillilab.github.io/bids-connectivity/>`_ `OSF project <https://osf.io/u4g5p/#!>`_
for access and management.

That being said, we can use :func:`datasets.download_HBN` ``function`` to download the respective ``data``, for example
to our ``Desktop``.

.. GENERATED FROM PYTHON SOURCE LINES 60-63

.. code-block:: default


    HBN_dataset_path = datasets.download_HBN()





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Downloading sub-NDARYM277DEA_ses-HBNsiteCBIC_acq-64dir_space-T1w_desc-preproc_dwi.bval
      0%|          | 0/642 [00:00<?, ?it/s]    100%|##########| 642/642 [00:00<00:00, 530kB/s]
    Downloading sub-NDARYM277DEA_ses-HBNsiteCBIC_acq-64dir_space-T1w_desc-preproc_dwi.bvec
      0%|          | 0/4457 [00:00<?, ?it/s]    100%|##########| 4.35k/4.35k [00:00<00:00, 3.31MB/s]
    Downloading sub-NDARYM277DEA_ses-HBNsiteCBIC_acq-64dir_space-T1w_desc-preproc_dwi.nii.gz
      0%|          | 0/359208318 [00:00<?, ?it/s]      0%|          | 1.38M/343M [00:00<00:25, 14.0MB/s]      1%|          | 3.25M/343M [00:00<00:20, 17.2MB/s]      2%|1         | 5.50M/343M [00:00<00:17, 20.1MB/s]      6%|6         | 20.6M/343M [00:00<00:04, 74.1MB/s]      8%|8         | 28.3M/343M [00:00<00:04, 76.5MB/s]     10%|#         | 35.7M/343M [00:00<00:08, 36.8MB/s]     13%|#2        | 43.2M/343M [00:01<00:07, 44.7MB/s]     17%|#7        | 59.2M/343M [00:01<00:04, 70.7MB/s]     20%|#9        | 68.4M/343M [00:01<00:04, 60.9MB/s]     22%|##2       | 76.2M/343M [00:01<00:06, 40.2MB/s]     26%|##6       | 89.9M/343M [00:01<00:04, 56.3MB/s]     29%|##8       | 98.3M/343M [00:02<00:04, 54.8MB/s]     31%|###       | 106M/343M [00:02<00:06, 36.4MB/s]      35%|###4      | 119M/343M [00:02<00:04, 50.7MB/s]     37%|###6      | 127M/343M [00:02<00:04, 49.0MB/s]     39%|###8      | 133M/343M [00:03<00:07, 30.6MB/s]     40%|####      | 139M/343M [00:03<00:06, 32.5MB/s]     44%|####3     | 149M/343M [00:03<00:04, 44.1MB/s]     45%|####5     | 156M/343M [00:03<00:05, 35.8MB/s]     47%|####6     | 161M/343M [00:04<00:07, 26.6MB/s]     48%|####8     | 165M/343M [00:04<00:06, 28.4MB/s]     51%|#####1    | 176M/343M [00:04<00:04, 42.0MB/s]     53%|#####3    | 182M/343M [00:04<00:05, 29.6MB/s]     55%|#####4    | 187M/343M [00:05<00:06, 25.9MB/s]     57%|#####7    | 196M/343M [00:05<00:04, 35.1MB/s]     59%|#####8    | 201M/343M [00:05<00:03, 39.2MB/s]     60%|######    | 207M/343M [00:05<00:05, 27.2MB/s]     62%|######1   | 211M/343M [00:05<00:05, 26.8MB/s]     65%|######4   | 222M/343M [00:05<00:03, 41.5MB/s]     67%|######7   | 231M/343M [00:06<00:02, 50.9MB/s]     69%|######9   | 238M/343M [00:06<00:03, 33.5MB/s]     71%|#######   | 243M/343M [00:06<00:03, 33.1MB/s]     75%|#######4  | 255M/343M [00:06<00:01, 49.5MB/s]     77%|#######6  | 262M/343M [00:07<00:02, 38.7MB/s]     78%|#######8  | 268M/343M [00:07<00:02, 29.0MB/s]     82%|########1 | 280M/343M [00:07<00:01, 42.3MB/s]     85%|########4 | 290M/343M [00:07<00:01, 52.7MB/s]     87%|########6 | 298M/343M [00:08<00:01, 29.7MB/s]     89%|########8 | 303M/343M [00:08<00:01, 28.2MB/s]     92%|#########2| 316M/343M [00:08<00:00, 41.5MB/s]     94%|#########4| 323M/343M [00:08<00:00, 45.5MB/s]     96%|#########6| 330M/343M [00:09<00:00, 33.6MB/s]     98%|#########7| 336M/343M [00:09<00:00, 37.7MB/s]    100%|##########| 343M/343M [00:09<00:00, 39.1MB/s]
    Downloading sub-NDARYM277DEA_ses-HBNsiteCBIC_acq-64dir_space-T1w_desc-brain_mask.nii.gz
      0%|          | 0/13243 [00:00<?, ?it/s]    100%|##########| 12.9k/12.9k [00:00<00:00, 10.4MB/s]
    Downloading sub-NDARYM277DEA_ses-HBNsiteCBIC_acq-64dir_space-T1w_desc-preproc_dwi.json
      0%|          | 0/3250 [00:00<?, ?it/s]    100%|##########| 3.17k/3.17k [00:00<00:00, 2.52MB/s]
    Downloading QSIprep/dataset_description.json
      0%|          | 0/499 [00:00<?, ?it/s]    100%|##########| 499/499 [00:00<00:00, 411kB/s]
    Downloading HBN/dataset_description.json
      0%|          | 0/60 [00:00<?, ?it/s]    100%|##########| 60.0/60.0 [00:00<00:00, 47.1kB/s]
    The following HBN files are available:
    HBN/
    ├─dataset_description.json
    ├─derivatives/
    │ └─QSIprep/
    │   ├─dataset_description.json
    │   └─sub-NDARYM277DEA/
    │     └─ses-HBNsiteCBIC/
    │       └─dwi/
    │         ├─sub-NDARYM277DEA_ses-HBNsiteCBIC_acq-64dir_space-T1w_desc-preproc_dwi.json
    │         ├─sub-NDARYM277DEA_ses-HBNsiteCBIC_acq-64dir_space-T1w_desc-preproc_dwi.bval
    │         ├─sub-NDARYM277DEA_ses-HBNsiteCBIC_acq-64dir_space-T1w_desc-preproc_dwi.nii.gz
    │         ├─sub-NDARYM277DEA_ses-HBNsiteCBIC_acq-64dir_space-T1w_desc-brain_mask.nii.gz
    │         └─sub-NDARYM277DEA_ses-HBNsiteCBIC_acq-64dir_space-T1w_desc-preproc_dwi.bvec
    └─source-HBN_desc-qsiprep_participants.tsv




.. GENERATED FROM PYTHON SOURCE LINES 64-74

Importantly, this ``function`` does not only obtain the ``participant``'s ``QSIprep`` output, but
also obtains the ``dataset_description.json`` and generates the ``data json sidecar`` ``file`` required by
`BIDS common derivatives <https://bids-specification.readthedocs.io/en/stable/05-derivatives/02-common-data-types.html>`_.
The latter is achieved by downloading the
`respective raw data json sidecar file <https://fcp-indi.s3.amazonaws.com/index.html#data/Projects/HBN/BIDS_curated/sub-NDAREK918EC2/ses-HBNsiteSI/dwi/>`_ and appending the needed ``inheritance-related`` & ``spatial reference-related`` information.

With that, we have a feasible ``HBN sub-dataset``, confirming to
`BIDS common derivatives <https://bids-specification.readthedocs.io/en/stable/05-derivatives/02-common-data-types.html>`_,
as well as
`inputs required by BEP16 <https://github.com/bids-standard/bids-bep016/pull/24/files>`_ and respective further processing.


.. rst-class:: sphx-glr-timing

   **Total running time of the script:** ( 0 minutes  18.466 seconds)


.. _sphx_glr_download_auto_examples_plot_HBN_download.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example


    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: plot_HBN_download.py <plot_HBN_download.py>`

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: plot_HBN_download.ipynb <plot_HBN_download.ipynb>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
